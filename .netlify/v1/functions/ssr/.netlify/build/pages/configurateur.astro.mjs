import { d as createComponent, j as renderComponent, r as renderTemplate, u as unescapeHTML, m as maybeRenderHead } from '../chunks/astro/server_CRDH0bDr.mjs';
import { $ as $$Layout } from '../chunks/Layout_D1VYXbu9.mjs';
export { renderers } from '../renderers.mjs';

const glassesSvg = "<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" viewBox=\"80 110 450 160\">\r\n  <defs>\r\n    <style>\r\n      .cls-1 {\r\n        fill: #706f6f;\r\n        mix-blend-mode: multiply;\r\n      }\r\n\r\n      .cls-2 {\r\n        isolation: isolate;\r\n      }\r\n\r\n      .cls-3, .cls-4 {\r\n        fill: #ffffff;\r\n      }\r\n\r\n      .cls-4 {\r\n        stroke: #1d1d1b;\r\n        stroke-miterlimit: 10;\r\n        stroke-width: .5px;\r\n      }\r\n\r\n      .cls-5 {\r\n        fill: none;\r\n        opacity: .75;\r\n      }\r\n    </style>\r\n  </defs>\r\n<!--Generator: Adobe Illustrator 28.7.1, SVG Export Plug-In . SVG Version: 1.2.0 Build 142)-->\r\n  <g class=\"cls-2\">\r\n    <g id=\"branches\">\r\n      <path class=\"cls-4\" d=\"M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z\"/>\r\n      <path class=\"cls-1\" d=\"M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z\"/>\r\n      <path class=\"cls-4\" d=\"M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z\"/>\r\n      <path class=\"cls-1\" d=\"M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z\"/>\r\n      <path class=\"cls-1\" d=\"M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z\"/>\r\n    </g>\r\n    <g id=\"verres\">\r\n      <path class=\"cls-5\" d=\"M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z\"/>\r\n      <path class=\"cls-5\" d=\"M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z\"/>\r\n    </g>\r\n    <g id=\"monture\">\r\n      <path class=\"cls-4\" d=\"M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z\"/>\r\n    </g>\r\n  </g>\r\n</svg>";

var __freeze = Object.freeze;
var __defProp = Object.defineProperty;
var __template = (cooked, raw) => __freeze(__defProp(cooked, "raw", { value: __freeze(raw || cooked.slice()) }));
var _a;
const $$Configurateur = createComponent(async ($$result, $$props, $$slots) => {
  return renderTemplate`${renderComponent($$result, "Layout", $$Layout, { "title": "Configurateur \u2014 TaVue" }, { "default": async ($$result2) => renderTemplate(_a || (_a = __template([" ", '<section class="mx-auto max-w-6xl px-4 py-8"> <div class="flex items-center justify-between"> <div> <h1 class="text-xl font-semibold">Personnalisez vos lunettes</h1> <p class="mt-1 text-sm text-gray-600">Cr\xE9ez votre paire unique en quelques clics</p> </div> <div class="text-right"> <div class="text-lg font-semibold">149\u20AC</div> <div class="text-xs text-gray-500">Prix estim\xE9</div> </div> </div> <div class="mt-3 h-1 w-full rounded bg-gray-200"> <div class="h-1 w-1/2 rounded bg-black"></div> </div> <div class="mt-6 grid gap-6 md:grid-cols-[1fr_1fr]"> <div class="space-y-4"> <div class="rounded-2xl border border-gray-200 p-3"> <div class="mb-2"> <span class="inline-flex items-center rounded-full bg-black/80 px-2 py-0.5 text-[11px] font-medium text-white">\nAper\xE7u en temps r\xE9el\n</span> </div> <div class="flex items-center justify-center rounded-xl bg-gray-50 p-4"> <div id="svg-mount" class="w-full max-w-[460px]">', `</div> </div> </div> <div class="rounded-2xl border border-gray-200 p-4"> <h3 class="text-sm font-semibold">R\xE9capitulatif</h3> <div class="mt-3 space-y-2 text-sm"> <div class="flex items-center justify-between"> <span>Monture</span><span id="recap-monture" class="inline-block h-3 w-10 rounded"></span> </div> <div class="flex items-center justify-between"> <span>Branches</span><span id="recap-branches" class="inline-block h-3 w-10 rounded"></span> </div> <div class="flex items-center justify-between"> <span>Verres</span><span id="recap-verres" class="inline-block h-3 w-10 rounded"></span> </div> <div class="flex items-center justify-between pt-2"> <span class="font-medium">Prix</span><span class="font-semibold">149\u20AC</span> </div> </div> </div> <div class="space-y-3"> <button type="button" class="w-full rounded-md bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-900">
Ajouter au panier \xB7 149\u20AC
</button> <div class="grid grid-cols-2 gap-3"> <button type="button" id="btn-save-config" class="w-full rounded-md border border-emerald-600 bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
Sauvegarder ma configuration
</button> <button type="button" id="btn-reset" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium hover:bg-gray-50">
R\xE9initialiser
</button> </div> </div> </div> <div class="space-y-4"> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">1</span> <h3 class="text-base font-semibold">Couleur de monture</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la teinte qui vous pla\xEEt</p> <div class="grid grid-cols-4 gap-3"> <button type="button" data-target="monture" data-color="#111111" class="color-btn h-10 rounded-full border" style="background:#111111"></button> <button type="button" data-target="monture" data-color="#904A39" class="color-btn h-10 rounded-full border" style="background:#904A39"></button> <button type="button" data-target="monture" data-color="#737373" class="color-btn h-10 rounded-full border" style="background:#737373"></button> <button type="button" data-target="monture" data-color="#FFFFFF" class="color-btn h-10 rounded-full border" style="background:#FFFFFF"></button> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">2</span> <h3 class="text-base font-semibold">Couleur des branches</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la teinte qui vous pla\xEEt</p> <div class="grid grid-cols-4 gap-3"> <button type="button" data-target="branches" data-color="#111111" class="color-btn h-10 rounded-full border" style="background:#111111"></button> <button type="button" data-target="branches" data-color="#904A39" class="color-btn h-10 rounded-full border" style="background:#904A39"></button> <button type="button" data-target="branches" data-color="#BFBFBF" class="color-btn h-10 rounded-full border" style="background:#BFBFBF"></button> <button type="button" data-target="branches" data-color="#FFFFFF" class="color-btn h-10 rounded-full border" style="background:#FFFFFF"></button> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">3</span> <h3 class="text-base font-semibold">Teinte des verres</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la teinte qui vous pla\xEEt</p> <div class="grid grid-cols-5 gap-3"> <button type="button" data-target="verres" data-color="#E5E7EB" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#E5E7EB"></button> <button type="button" data-target="verres" data-color="#E8AB9B" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#E8AB9B"></button> <button type="button" data-target="verres" data-color="#E9D265" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#E9D265"></button> <button type="button" data-target="verres" data-color="#7B4B3A" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#7B4B3A"></button> <button type="button" data-target="verres" data-color="#FFFFFF" data-alpha="0.10" class="lens-btn h-10 rounded-full border" style="background:#FFFFFF"></button> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">5</span> <h3 class="text-base font-semibold">Dimensions</h3> </div> <div class="space-y-4"> <label class="block"> <div class="mb-1 flex items-center justify-between text-xs text-gray-600"> <span>Taille des verres</span> <span id="label-lens-scale" class="tabular-nums">100%</span> </div> <input id="lens-scale" type="range" min="90" max="110" step="1" class="w-full accent-black" value="100"> <p class="mt-1 text-[11px] text-gray-500">Agrandit/r\xE9duit l\xE9g\xE8rement chaque verre (\xB110%).</p> </label> <label class="block"> <div class="mb-1 flex items-center justify-between text-xs text-gray-600"> <span>Largeur du pont</span> <span id="label-bridge" class="tabular-nums">0%</span> </div> <input id="bridge-offset" type="range" min="-10" max="10" step="1" class="w-full accent-black" value="0"> <p class="mt-1 text-[11px] text-gray-500">\xC9carte ou rapproche la monture (\xB110%).</p> </label> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">4</span> <h3 class="text-base font-semibold">Mat\xE9riau de la monture</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la mati\xE8re qui vous convient</p> <div id="material-group" class="space-y-3" role="radiogroup" aria-label="Mat\xE9riau de la monture"> <button type="button" role="radio" aria-checked="true" tabindex="0" data-value="acetate" class="material-card w-full text-left rounded-xl border-2 border-black/70 bg-blue-50/30 px-4 py-3"> <div class="flex items-center justify-between text-sm"> <span class="font-medium">Ac\xE9tate</span> <span class="text-xs">+0\u20AC</span> </div> <div class="mt-1 text-xs text-gray-600">L\xE9ger et confortable</div> </button> <button type="button" role="radio" aria-checked="false" tabindex="-1" data-value="metal" class="material-card w-full text-left rounded-xl border border-gray-200 px-4 py-3 hover:border-gray-300"> <div class="flex items-center justify-between text-sm"> <span class="font-medium">M\xE9tal</span> <span class="text-xs">+40\u20AC</span> </div> <div class="mt-1 text-xs text-gray-600">\xC9l\xE9gant et durable</div> </button> <button type="button" role="radio" aria-checked="false" tabindex="-1" data-value="titane" class="material-card w-full text-left rounded-xl border border-gray-200 px-4 py-3 hover:border-gray-300"> <div class="flex items-center justify-between text-sm"> <span class="font-medium">Titane</span> <span class="text-xs">+80\u20AC</span> </div> <div class="mt-1 text-xs text-gray-600">Premium \xB7 Ultra-l\xE9ger</div> </button> </div> </article> </div> </div> </section> <script>
    function acquireRefs() {
      const svg = document.querySelector('#svg-mount svg');
      const grpMonture = svg?.querySelector('#monture');
      const grpBranches = svg?.querySelector('#branches');
      const grpVerres = svg?.querySelector('#verres');

      window._svgRefs = {
        svg,
        grpMonture,
        grpBranches,
        grpVerres,
        frameParts: grpMonture?.querySelectorAll('.cls-4') || [],
        bigBranchParts: grpBranches?.querySelectorAll('.cls-4') || [],
        lensParts: grpVerres?.querySelectorAll('path') || [],
      };
    }
    acquireRefs();

    const state = {
      monture: '#9CA3AF',
      branches: '#706f6f',
      verres: '#E5E7EB',
      alpha: 0.35,
      lensScale: 1.0,
      bridgeScale: 1.0,
      taille_verre: 100,
      largeur_pont: 0,
      material: 'acetate',
      _currentId: null, 
    };
    window.state = state;

    const recapMonture  = document.getElementById('recap-monture');
    const recapBranches = document.getElementById('recap-branches');
    const recapVerres   = document.getElementById('recap-verres');

    function applyFrameColor(color) {
      (window._svgRefs?.frameParts || []).forEach(p => p.style.fill = color);
      recapMonture.style.background = color;
      state.monture = color;
    }
    function applyBranchColor(color) {
      (window._svgRefs?.bigBranchParts || []).forEach(p => p.style.fill = color);
      recapBranches.style.background = color;
      state.branches = color;
    }
    function applyLensTint(color, alpha = 0.35) {
      (window._svgRefs?.lensParts || []).forEach(p => {
        p.style.fill = color;
        p.style.opacity = alpha;
      });
      recapVerres.style.background = color;
      recapVerres.style.opacity = alpha;
      state.verres = color;
      state.alpha = alpha;
    }

    function setScaleAroundCenter(el, sx = 1, sy = 1) {
      const b = el.getBBox();
      const cx = b.x + b.width / 2;
      const cy = b.y + b.height / 2;
      el.setAttribute('transform', \`translate(\${cx} \${cy}) scale(\${sx} \${sy}) translate(\${-cx} \${-cy})\`);
    }

    function recomputeMontureCenter() {
      const m = window._svgRefs?.grpMonture;
      const b = m.getBBox();
      return { cx: b.x + b.width / 2, cy: b.y + b.height / 2 };
    }

    function applyLensScale(scale) {
      state.lensScale = scale;
      state.taille_verre = Math.round(scale * 100);
      (window._svgRefs?.lensParts || []).forEach(el => setScaleAroundCenter(el, scale, scale));
      const label = document.getElementById('label-lens-scale');
      if (label) label.textContent = \`\${state.taille_verre}%\`;
      const slider = document.getElementById('lens-scale');
      if (slider) slider.value = String(Math.round(scale * 100));
    }

    function applyBridgeScale(scaleX) {
      state.bridgeScale = scaleX;
      state.largeur_pont = Math.round((scaleX - 1) * 100);
      const { cx, cy } = recomputeMontureCenter();
      const m = window._svgRefs?.grpMonture;
      if (m) m.setAttribute('transform', \`translate(\${cx} \${cy}) scale(\${scaleX} 1) translate(\${-cx} \${-cy})\`);
      const lab = document.getElementById('label-bridge');
      if (lab) lab.textContent = (state.largeur_pont > 0 ? \`+\${state.largeur_pont}\` : \`\${state.largeur_pont}\`) + '%';
      const slider = document.getElementById('bridge-offset');
      if (slider) slider.value = String(state.largeur_pont);
    }

    applyFrameColor(state.monture);
    applyBranchColor(state.branches);
    applyLensTint(state.verres, state.alpha);

    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        const color  = btn.getAttribute('data-color');
        if (target === 'monture')  applyFrameColor(color);
        if (target === 'branches') applyBranchColor(color);
      });
    });

    document.querySelectorAll('.lens-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const color = btn.getAttribute('data-color');
        const alpha = parseFloat(btn.getAttribute('data-alpha') || '0.35');
        applyLensTint(color, alpha);
      });
    });

    const lensScaleInput = document.getElementById('lens-scale');
    const bridgeInput    = document.getElementById('bridge-offset');
    lensScaleInput?.addEventListener('input', () => applyLensScale(Number(lensScaleInput.value)/100));
    bridgeInput?.addEventListener('input', () => applyBridgeScale(1 + Number(bridgeInput.value)/100));

    const matGroup = document.getElementById('material-group');
    const selectedClasses = ['border-2','border-black/70','bg-blue-50/30'];
    function selectMaterial(card) {
      matGroup.querySelectorAll('.material-card').forEach(btn => {
        btn.classList.remove(...selectedClasses);
        btn.classList.add('border','border-gray-200');
        btn.setAttribute('aria-checked','false');
        btn.tabIndex = -1;
      });
      card.classList.add(...selectedClasses);
      card.classList.remove('border','border-gray-200');
      card.setAttribute('aria-checked','true');
      card.tabIndex = 0;
      card.focus();
      state.material = card.dataset.value;
    }
    matGroup.addEventListener('click', (e) => {
      const card = e.target.closest('.material-card');
      if (card) selectMaterial(card);
    });
    matGroup.addEventListener('keydown', (e) => {
      const cards = [...matGroup.querySelectorAll('.material-card')];
      const current = document.activeElement.closest('.material-card') || cards[0];
      const i = cards.indexOf(current);
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault(); selectMaterial(cards[(i + 1) % cards.length]);
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault(); selectMaterial(cards[(i - 1 + cards.length) % cards.length]);
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault(); selectMaterial(current);
      }
    });

    function serializeCurrentSVG() {
      const svgEl = document.querySelector('#svg-mount svg');
      if (!svgEl) return "";
      const clone = svgEl.cloneNode(true);
      if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      if (!clone.getAttribute('version')) clone.setAttribute('version', '1.1');
      if (!clone.getAttribute('viewBox')) {
        const bb = svgEl.getBBox();
        clone.setAttribute('viewBox', \`\${bb.x} \${bb.y} \${bb.width} \${bb.height}\`);
        clone.removeAttribute('width');
        clone.removeAttribute('height');
        clone.style.width = '100%';
        clone.style.height = 'auto';
      }
      return clone.outerHTML;
    }

    async function saveToPB(params) {
  const r = await fetch('/api/saveSVG', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',           
    body: JSON.stringify(params),
  });
  return await r.json();
}

async function updateToPB(params) {
  const r = await fetch('/api/updateSVG', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',           
    body: JSON.stringify(params),
  });
  return await r.json();
}
    async function fetchLunetteById(id) {
      const r = await fetch(\`/api/lunettes/\${id}\`);
      return await r.json();
    }

    function mountFromSVG(svgString) {
      const mount = document.getElementById('svg-mount');
      mount.innerHTML = svgString;
      acquireRefs(); 
    }

    (async function bootFromQuery() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return;
      try {
        const { success, item, error } = await fetchLunetteById(id);
        if (!success) throw new Error(error || 'fetch failed');

        mountFromSVG(item.code_svg);

        if (item.couleur_monture)  applyFrameColor(item.couleur_monture);
        if (item.couleur_branches) applyBranchColor(item.couleur_branches);
        if (item.teinte_verres)    applyLensTint(item.teinte_verres, state.alpha ?? 0.35);

        const tv = Number(item.taille_verre ?? 100);
        const lp = Number(item.largeur_pont ?? 0);
        applyLensScale(tv / 100);
        applyBridgeScale(1 + lp / 100);

        state.material = item.material || 'acetate';
        state._currentId = item.id;

        const btn = document.getElementById('btn-save-config');
        if (btn) btn.textContent = 'Mettre \xE0 jour cette configuration';
      } catch (e) {
        console.error('[configurateur] load error:', e);
        alert('Impossible de charger la configuration. Elle reste \xE9ditable, mais non li\xE9e.');
      }
    })();

    async function saveOrUpdateCurrent() {
      const code_svg = serializeCurrentSVG();
      if (!code_svg || !code_svg.startsWith('<svg')) {
        alert("Aucun SVG valide \xE0 sauvegarder.");
        return;
      }

      const currentName = (state._currentId ? undefined : undefined); 
      const nom = prompt("Nom de votre cr\xE9ation :", currentName || "Ma paire") || "Sans nom";

      const payload = {
        nom_lunette: nom,
        code_svg,
        prix: 149,
        couleur_monture: state.monture,
        couleur_branches: state.branches,
        teinte_verres: state.verres,
        taille_verre: state.taille_verre ?? 100,
        largeur_pont: state.largeur_pont ?? 0,
        material: state.material || 'acetate',
        genere_IA: false,
        prompt_ia: "",
      };

      let r;
      if (state._currentId) {
        r = await updateToPB({ id: state._currentId, ...payload });
      } else {
        r = await saveToPB(payload);
        if (r.success) state._currentId = r.id;
      }

      if (r.success) {
        alert((state._currentId ? 'Configuration enregistr\xE9e' : 'Configuration enregistr\xE9e') + \` \u2705 (id: \${r.id})\`);
      } else {
        alert('Erreur sauvegarde: ' + r.error);
      }
    }

    document.getElementById('btn-save-config')?.addEventListener('click', saveOrUpdateCurrent);

    document.getElementById('btn-reset')?.addEventListener('click', () => {
      applyFrameColor('#FFFFFF');
      applyBranchColor('#111111');
      applyLensTint('#FFFFFF', 0.10);
      applyLensScale(1.0);
      applyBridgeScale(1.0);
      state.material = 'acetate';
      state._currentId = null;
      const btn = document.getElementById('btn-save-config');
      if (btn) btn.textContent = 'Sauvegarder ma configuration';
    });
  <\/script> `], [" ", '<section class="mx-auto max-w-6xl px-4 py-8"> <div class="flex items-center justify-between"> <div> <h1 class="text-xl font-semibold">Personnalisez vos lunettes</h1> <p class="mt-1 text-sm text-gray-600">Cr\xE9ez votre paire unique en quelques clics</p> </div> <div class="text-right"> <div class="text-lg font-semibold">149\u20AC</div> <div class="text-xs text-gray-500">Prix estim\xE9</div> </div> </div> <div class="mt-3 h-1 w-full rounded bg-gray-200"> <div class="h-1 w-1/2 rounded bg-black"></div> </div> <div class="mt-6 grid gap-6 md:grid-cols-[1fr_1fr]"> <div class="space-y-4"> <div class="rounded-2xl border border-gray-200 p-3"> <div class="mb-2"> <span class="inline-flex items-center rounded-full bg-black/80 px-2 py-0.5 text-[11px] font-medium text-white">\nAper\xE7u en temps r\xE9el\n</span> </div> <div class="flex items-center justify-center rounded-xl bg-gray-50 p-4"> <div id="svg-mount" class="w-full max-w-[460px]">', `</div> </div> </div> <div class="rounded-2xl border border-gray-200 p-4"> <h3 class="text-sm font-semibold">R\xE9capitulatif</h3> <div class="mt-3 space-y-2 text-sm"> <div class="flex items-center justify-between"> <span>Monture</span><span id="recap-monture" class="inline-block h-3 w-10 rounded"></span> </div> <div class="flex items-center justify-between"> <span>Branches</span><span id="recap-branches" class="inline-block h-3 w-10 rounded"></span> </div> <div class="flex items-center justify-between"> <span>Verres</span><span id="recap-verres" class="inline-block h-3 w-10 rounded"></span> </div> <div class="flex items-center justify-between pt-2"> <span class="font-medium">Prix</span><span class="font-semibold">149\u20AC</span> </div> </div> </div> <div class="space-y-3"> <button type="button" class="w-full rounded-md bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-900">
Ajouter au panier \xB7 149\u20AC
</button> <div class="grid grid-cols-2 gap-3"> <button type="button" id="btn-save-config" class="w-full rounded-md border border-emerald-600 bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
Sauvegarder ma configuration
</button> <button type="button" id="btn-reset" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium hover:bg-gray-50">
R\xE9initialiser
</button> </div> </div> </div> <div class="space-y-4"> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">1</span> <h3 class="text-base font-semibold">Couleur de monture</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la teinte qui vous pla\xEEt</p> <div class="grid grid-cols-4 gap-3"> <button type="button" data-target="monture" data-color="#111111" class="color-btn h-10 rounded-full border" style="background:#111111"></button> <button type="button" data-target="monture" data-color="#904A39" class="color-btn h-10 rounded-full border" style="background:#904A39"></button> <button type="button" data-target="monture" data-color="#737373" class="color-btn h-10 rounded-full border" style="background:#737373"></button> <button type="button" data-target="monture" data-color="#FFFFFF" class="color-btn h-10 rounded-full border" style="background:#FFFFFF"></button> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">2</span> <h3 class="text-base font-semibold">Couleur des branches</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la teinte qui vous pla\xEEt</p> <div class="grid grid-cols-4 gap-3"> <button type="button" data-target="branches" data-color="#111111" class="color-btn h-10 rounded-full border" style="background:#111111"></button> <button type="button" data-target="branches" data-color="#904A39" class="color-btn h-10 rounded-full border" style="background:#904A39"></button> <button type="button" data-target="branches" data-color="#BFBFBF" class="color-btn h-10 rounded-full border" style="background:#BFBFBF"></button> <button type="button" data-target="branches" data-color="#FFFFFF" class="color-btn h-10 rounded-full border" style="background:#FFFFFF"></button> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">3</span> <h3 class="text-base font-semibold">Teinte des verres</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la teinte qui vous pla\xEEt</p> <div class="grid grid-cols-5 gap-3"> <button type="button" data-target="verres" data-color="#E5E7EB" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#E5E7EB"></button> <button type="button" data-target="verres" data-color="#E8AB9B" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#E8AB9B"></button> <button type="button" data-target="verres" data-color="#E9D265" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#E9D265"></button> <button type="button" data-target="verres" data-color="#7B4B3A" data-alpha="0.35" class="lens-btn h-10 rounded-full border" style="background:#7B4B3A"></button> <button type="button" data-target="verres" data-color="#FFFFFF" data-alpha="0.10" class="lens-btn h-10 rounded-full border" style="background:#FFFFFF"></button> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">5</span> <h3 class="text-base font-semibold">Dimensions</h3> </div> <div class="space-y-4"> <label class="block"> <div class="mb-1 flex items-center justify-between text-xs text-gray-600"> <span>Taille des verres</span> <span id="label-lens-scale" class="tabular-nums">100%</span> </div> <input id="lens-scale" type="range" min="90" max="110" step="1" class="w-full accent-black" value="100"> <p class="mt-1 text-[11px] text-gray-500">Agrandit/r\xE9duit l\xE9g\xE8rement chaque verre (\xB110%).</p> </label> <label class="block"> <div class="mb-1 flex items-center justify-between text-xs text-gray-600"> <span>Largeur du pont</span> <span id="label-bridge" class="tabular-nums">0%</span> </div> <input id="bridge-offset" type="range" min="-10" max="10" step="1" class="w-full accent-black" value="0"> <p class="mt-1 text-[11px] text-gray-500">\xC9carte ou rapproche la monture (\xB110%).</p> </label> </div> </article> <article class="rounded-2xl border border-gray-200 p-4"> <div class="mb-2 flex items-center gap-2"> <span class="flex h-7 w-7 items-center justify-center rounded-full border text-sm">4</span> <h3 class="text-base font-semibold">Mat\xE9riau de la monture</h3> </div> <p class="mb-3 text-xs text-gray-600">S\xE9lectionnez la mati\xE8re qui vous convient</p> <div id="material-group" class="space-y-3" role="radiogroup" aria-label="Mat\xE9riau de la monture"> <button type="button" role="radio" aria-checked="true" tabindex="0" data-value="acetate" class="material-card w-full text-left rounded-xl border-2 border-black/70 bg-blue-50/30 px-4 py-3"> <div class="flex items-center justify-between text-sm"> <span class="font-medium">Ac\xE9tate</span> <span class="text-xs">+0\u20AC</span> </div> <div class="mt-1 text-xs text-gray-600">L\xE9ger et confortable</div> </button> <button type="button" role="radio" aria-checked="false" tabindex="-1" data-value="metal" class="material-card w-full text-left rounded-xl border border-gray-200 px-4 py-3 hover:border-gray-300"> <div class="flex items-center justify-between text-sm"> <span class="font-medium">M\xE9tal</span> <span class="text-xs">+40\u20AC</span> </div> <div class="mt-1 text-xs text-gray-600">\xC9l\xE9gant et durable</div> </button> <button type="button" role="radio" aria-checked="false" tabindex="-1" data-value="titane" class="material-card w-full text-left rounded-xl border border-gray-200 px-4 py-3 hover:border-gray-300"> <div class="flex items-center justify-between text-sm"> <span class="font-medium">Titane</span> <span class="text-xs">+80\u20AC</span> </div> <div class="mt-1 text-xs text-gray-600">Premium \xB7 Ultra-l\xE9ger</div> </button> </div> </article> </div> </div> </section> <script>
    function acquireRefs() {
      const svg = document.querySelector('#svg-mount svg');
      const grpMonture = svg?.querySelector('#monture');
      const grpBranches = svg?.querySelector('#branches');
      const grpVerres = svg?.querySelector('#verres');

      window._svgRefs = {
        svg,
        grpMonture,
        grpBranches,
        grpVerres,
        frameParts: grpMonture?.querySelectorAll('.cls-4') || [],
        bigBranchParts: grpBranches?.querySelectorAll('.cls-4') || [],
        lensParts: grpVerres?.querySelectorAll('path') || [],
      };
    }
    acquireRefs();

    const state = {
      monture: '#9CA3AF',
      branches: '#706f6f',
      verres: '#E5E7EB',
      alpha: 0.35,
      lensScale: 1.0,
      bridgeScale: 1.0,
      taille_verre: 100,
      largeur_pont: 0,
      material: 'acetate',
      _currentId: null, 
    };
    window.state = state;

    const recapMonture  = document.getElementById('recap-monture');
    const recapBranches = document.getElementById('recap-branches');
    const recapVerres   = document.getElementById('recap-verres');

    function applyFrameColor(color) {
      (window._svgRefs?.frameParts || []).forEach(p => p.style.fill = color);
      recapMonture.style.background = color;
      state.monture = color;
    }
    function applyBranchColor(color) {
      (window._svgRefs?.bigBranchParts || []).forEach(p => p.style.fill = color);
      recapBranches.style.background = color;
      state.branches = color;
    }
    function applyLensTint(color, alpha = 0.35) {
      (window._svgRefs?.lensParts || []).forEach(p => {
        p.style.fill = color;
        p.style.opacity = alpha;
      });
      recapVerres.style.background = color;
      recapVerres.style.opacity = alpha;
      state.verres = color;
      state.alpha = alpha;
    }

    function setScaleAroundCenter(el, sx = 1, sy = 1) {
      const b = el.getBBox();
      const cx = b.x + b.width / 2;
      const cy = b.y + b.height / 2;
      el.setAttribute('transform', \\\`translate(\\\${cx} \\\${cy}) scale(\\\${sx} \\\${sy}) translate(\\\${-cx} \\\${-cy})\\\`);
    }

    function recomputeMontureCenter() {
      const m = window._svgRefs?.grpMonture;
      const b = m.getBBox();
      return { cx: b.x + b.width / 2, cy: b.y + b.height / 2 };
    }

    function applyLensScale(scale) {
      state.lensScale = scale;
      state.taille_verre = Math.round(scale * 100);
      (window._svgRefs?.lensParts || []).forEach(el => setScaleAroundCenter(el, scale, scale));
      const label = document.getElementById('label-lens-scale');
      if (label) label.textContent = \\\`\\\${state.taille_verre}%\\\`;
      const slider = document.getElementById('lens-scale');
      if (slider) slider.value = String(Math.round(scale * 100));
    }

    function applyBridgeScale(scaleX) {
      state.bridgeScale = scaleX;
      state.largeur_pont = Math.round((scaleX - 1) * 100);
      const { cx, cy } = recomputeMontureCenter();
      const m = window._svgRefs?.grpMonture;
      if (m) m.setAttribute('transform', \\\`translate(\\\${cx} \\\${cy}) scale(\\\${scaleX} 1) translate(\\\${-cx} \\\${-cy})\\\`);
      const lab = document.getElementById('label-bridge');
      if (lab) lab.textContent = (state.largeur_pont > 0 ? \\\`+\\\${state.largeur_pont}\\\` : \\\`\\\${state.largeur_pont}\\\`) + '%';
      const slider = document.getElementById('bridge-offset');
      if (slider) slider.value = String(state.largeur_pont);
    }

    applyFrameColor(state.monture);
    applyBranchColor(state.branches);
    applyLensTint(state.verres, state.alpha);

    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        const color  = btn.getAttribute('data-color');
        if (target === 'monture')  applyFrameColor(color);
        if (target === 'branches') applyBranchColor(color);
      });
    });

    document.querySelectorAll('.lens-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const color = btn.getAttribute('data-color');
        const alpha = parseFloat(btn.getAttribute('data-alpha') || '0.35');
        applyLensTint(color, alpha);
      });
    });

    const lensScaleInput = document.getElementById('lens-scale');
    const bridgeInput    = document.getElementById('bridge-offset');
    lensScaleInput?.addEventListener('input', () => applyLensScale(Number(lensScaleInput.value)/100));
    bridgeInput?.addEventListener('input', () => applyBridgeScale(1 + Number(bridgeInput.value)/100));

    const matGroup = document.getElementById('material-group');
    const selectedClasses = ['border-2','border-black/70','bg-blue-50/30'];
    function selectMaterial(card) {
      matGroup.querySelectorAll('.material-card').forEach(btn => {
        btn.classList.remove(...selectedClasses);
        btn.classList.add('border','border-gray-200');
        btn.setAttribute('aria-checked','false');
        btn.tabIndex = -1;
      });
      card.classList.add(...selectedClasses);
      card.classList.remove('border','border-gray-200');
      card.setAttribute('aria-checked','true');
      card.tabIndex = 0;
      card.focus();
      state.material = card.dataset.value;
    }
    matGroup.addEventListener('click', (e) => {
      const card = e.target.closest('.material-card');
      if (card) selectMaterial(card);
    });
    matGroup.addEventListener('keydown', (e) => {
      const cards = [...matGroup.querySelectorAll('.material-card')];
      const current = document.activeElement.closest('.material-card') || cards[0];
      const i = cards.indexOf(current);
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault(); selectMaterial(cards[(i + 1) % cards.length]);
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault(); selectMaterial(cards[(i - 1 + cards.length) % cards.length]);
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault(); selectMaterial(current);
      }
    });

    function serializeCurrentSVG() {
      const svgEl = document.querySelector('#svg-mount svg');
      if (!svgEl) return "";
      const clone = svgEl.cloneNode(true);
      if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      if (!clone.getAttribute('version')) clone.setAttribute('version', '1.1');
      if (!clone.getAttribute('viewBox')) {
        const bb = svgEl.getBBox();
        clone.setAttribute('viewBox', \\\`\\\${bb.x} \\\${bb.y} \\\${bb.width} \\\${bb.height}\\\`);
        clone.removeAttribute('width');
        clone.removeAttribute('height');
        clone.style.width = '100%';
        clone.style.height = 'auto';
      }
      return clone.outerHTML;
    }

    async function saveToPB(params) {
  const r = await fetch('/api/saveSVG', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',           
    body: JSON.stringify(params),
  });
  return await r.json();
}

async function updateToPB(params) {
  const r = await fetch('/api/updateSVG', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',           
    body: JSON.stringify(params),
  });
  return await r.json();
}
    async function fetchLunetteById(id) {
      const r = await fetch(\\\`/api/lunettes/\\\${id}\\\`);
      return await r.json();
    }

    function mountFromSVG(svgString) {
      const mount = document.getElementById('svg-mount');
      mount.innerHTML = svgString;
      acquireRefs(); 
    }

    (async function bootFromQuery() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return;
      try {
        const { success, item, error } = await fetchLunetteById(id);
        if (!success) throw new Error(error || 'fetch failed');

        mountFromSVG(item.code_svg);

        if (item.couleur_monture)  applyFrameColor(item.couleur_monture);
        if (item.couleur_branches) applyBranchColor(item.couleur_branches);
        if (item.teinte_verres)    applyLensTint(item.teinte_verres, state.alpha ?? 0.35);

        const tv = Number(item.taille_verre ?? 100);
        const lp = Number(item.largeur_pont ?? 0);
        applyLensScale(tv / 100);
        applyBridgeScale(1 + lp / 100);

        state.material = item.material || 'acetate';
        state._currentId = item.id;

        const btn = document.getElementById('btn-save-config');
        if (btn) btn.textContent = 'Mettre \xE0 jour cette configuration';
      } catch (e) {
        console.error('[configurateur] load error:', e);
        alert('Impossible de charger la configuration. Elle reste \xE9ditable, mais non li\xE9e.');
      }
    })();

    async function saveOrUpdateCurrent() {
      const code_svg = serializeCurrentSVG();
      if (!code_svg || !code_svg.startsWith('<svg')) {
        alert("Aucun SVG valide \xE0 sauvegarder.");
        return;
      }

      const currentName = (state._currentId ? undefined : undefined); 
      const nom = prompt("Nom de votre cr\xE9ation :", currentName || "Ma paire") || "Sans nom";

      const payload = {
        nom_lunette: nom,
        code_svg,
        prix: 149,
        couleur_monture: state.monture,
        couleur_branches: state.branches,
        teinte_verres: state.verres,
        taille_verre: state.taille_verre ?? 100,
        largeur_pont: state.largeur_pont ?? 0,
        material: state.material || 'acetate',
        genere_IA: false,
        prompt_ia: "",
      };

      let r;
      if (state._currentId) {
        r = await updateToPB({ id: state._currentId, ...payload });
      } else {
        r = await saveToPB(payload);
        if (r.success) state._currentId = r.id;
      }

      if (r.success) {
        alert((state._currentId ? 'Configuration enregistr\xE9e' : 'Configuration enregistr\xE9e') + \\\` \u2705 (id: \\\${r.id})\\\`);
      } else {
        alert('Erreur sauvegarde: ' + r.error);
      }
    }

    document.getElementById('btn-save-config')?.addEventListener('click', saveOrUpdateCurrent);

    document.getElementById('btn-reset')?.addEventListener('click', () => {
      applyFrameColor('#FFFFFF');
      applyBranchColor('#111111');
      applyLensTint('#FFFFFF', 0.10);
      applyLensScale(1.0);
      applyBridgeScale(1.0);
      state.material = 'acetate';
      state._currentId = null;
      const btn = document.getElementById('btn-save-config');
      if (btn) btn.textContent = 'Sauvegarder ma configuration';
    });
  <\/script> `])), maybeRenderHead(), unescapeHTML(glassesSvg)) })}`;
}, "C:/Users/ghuyt/OneDrive/Documents/GitHub/sae301-2025-Noahbrrt/src/pages/configurateur.astro", void 0);

const $$file = "C:/Users/ghuyt/OneDrive/Documents/GitHub/sae301-2025-Noahbrrt/src/pages/configurateur.astro";
const $$url = "/configurateur";

const _page = /*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({
  __proto__: null,
  default: $$Configurateur,
  file: $$file,
  url: $$url
}, Symbol.toStringTag, { value: 'Module' }));

const page = () => _page;

export { page };
