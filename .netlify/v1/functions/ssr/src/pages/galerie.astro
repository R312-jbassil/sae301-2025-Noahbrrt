---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { getPB } from "../utils/pb.js";                 // <- .js
import { Collections } from "../utils/pocketbase-types.js";

const pb = await getPB();

// ⚠️ Charger le cookie pb_auth et valider le token pour le client PB côté serveur
const cookie = Astro.cookies.get("pb_auth")?.value;
if (cookie) {
  pb.authStore.loadFromCookie(cookie);
  try { await pb.collection("users").authRefresh(); }   // valide/rafraîchit
  catch { pb.authStore.clear(); }
}

// user mis par le middleware (utile pour le filtre)
const user = Astro.locals.user;

let items = [];
try {
  items = await pb.collection(Collections.Lunettes).getFullList({
    sort: "-created",
    filter: `user = "${user.id}"`,
  });
} catch (e) {
  console.error("[galerie] PB error:", e?.status, e?.message, e?.data);
  items = [];
}
---

<Layout title="Mes lunettes — Galerie">
  {items.length === 0 ? (
    <p class="text-sm text-gray-600">Aucune création pour l’instant. Lance le configurateur !</p>
  ) : (
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {items.map((it) => (
        <article class="rounded-2xl border bg-white shadow-sm overflow-hidden">
          <div class="aspect-[4/3] grid place-items-center bg-gray-50 p-4">
            <div class="w-full max-w-[420px]" set:html={it.code_svg}></div>
          </div>
          <div class="p-4 space-y-2 text-sm">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold truncate" title={it.nom_lunette}>{it.nom_lunette || 'Sans nom'}</h3>
              <span class="text-xs text-gray-500">{new Date(it.created).toLocaleDateString()}</span>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              {it.couleur_monture && <span class="text-[11px] border rounded px-2 py-0.5">Monture</span>}
              {typeof it.taille_verre !== 'undefined' && <span class="text-[11px] border rounded px-2 py-0.5">Verres {it.taille_verre}%</span>}
              {typeof it.largeur_pont !== 'undefined' && <span class="text-[11px] border rounded px-2 py-0.5">Pont {it.largeur_pont >= 0 ? '+' : ''}{it.largeur_pont}%</span>}
              {it.genere_IA ? <span class="text-[11px] rounded px-2 py-0.5 bg-purple-50 border border-purple-200">IA</span>
                             : <span class="text-[11px] rounded px-2 py-0.5 bg-emerald-50 border-emerald-200 border">Config</span>}
            </div>
            <div class="pt-2">
             <a
  href={`${it.genere_IA ? '/ia-generator' : '/configurateur'}?id=${it.id}`}
  class="text-xs underline hover:no-underline"
>
  {it.genere_IA ? 'Continuer la génération IA' : 'Continuer la configuration'}
</a>
            </div>
          </div>
        </article>
      ))}
    </div>
  )}
</Layout>
